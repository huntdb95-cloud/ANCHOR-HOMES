<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anchor Dashboard | Anchor Homes LLC</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    .anchor-wrapper {
      margin: 0 auto 2.5rem;
      max-width: 960px;
    }

    /* Owner Login card styling and readable text */
    .anchor-login-card {
      background: #f9fafb;
      color: #111827;
    }

    .anchor-login-card * {
      color: #111827 !important;
    }

    .anchor-login-card .form-input {
      background: #ffffff;
      color: #111827;
    }

    /* Dashboard text should also be dark and readable */
    .anchor-dashboard {
      background: #ffffff;
      color: #111827;
    }

    .anchor-dashboard h2,
    .anchor-dashboard p {
      color: #111827;
    }

    .anchor-login-card h1 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }

    .anchor-dashboard h2 {
      margin-top: 0;
      margin-bottom: 0.75rem;
    }

    .anchor-login-row {
      margin-top: 0.75rem;
    }

    .anchor-login-error {
      font-size: 0.85rem;
      color: #b91c1c;
      margin-left: 0.75rem;
      display: none;
    }

    .anchor-section-card {
      border-radius: 0.75rem;
      border: 1px solid rgba(15, 23, 42, 0.08);
      padding: 1rem 1rem 0.75rem;
      background: #f9fafb;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .anchor-section-card h3 {
      margin: 0;
      color: #111827;
    }

    .anchor-section-card p {
      font-size: 0.9rem;
      margin: 0;
      color: #111827;
    }

    .anchor-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.25rem;
    }

    .anchor-links a {
      font-size: 0.85rem;
      text-decoration: none;
      padding: 0.45rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.18);
      background: #ffffff;
      color: #111827;
    }

    .anchor-iframe-wrapper {
      margin-top: 0.75rem;
      border-radius: 0.75rem;
      overflow: hidden;
      border: 1px solid rgba(15, 23, 42, 0.12);
      background: #ffffff;
    }

    .anchor-iframe-wrapper iframe {
      display: block;
      width: 100%;
      border: 0;
      min-height: 550px;
    }

    .anchor-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.75rem;
    }

    /* COI tracker styles */
    .coi-form-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr) minmax(0, 1fr) auto;
      gap: 0.6rem;
      align-items: flex-end;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .coi-form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .coi-alert-bar {
      margin-top: 0.75rem;
      border-radius: 0.75rem;
      border: 1px solid rgba(245, 158, 11, 0.4);
      background: #fffbeb;
      padding: 0.6rem 0.75rem;
      font-size: 0.85rem;
      display: none;
    }

    .coi-alert-title {
      font-weight: 600;
      margin-bottom: 0.35rem;
      color: #92400e;
    }

    .coi-alert-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .coi-alert-chip {
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background: #f97316;
      color: #ffffff;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .coi-filter-bar {
      margin-top: 0.8rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
      align-items: center;
      font-size: 0.85rem;
    }

    .coi-filter-label {
      color: #6b7280;
      margin-right: 0.25rem;
    }

    .coi-filter-btn {
      font-size: 0.8rem;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.18);
      background: #ffffff;
      cursor: pointer;
    }

    .coi-filter-btn.active {
      background: #0f766e;
      border-color: #0f766e;
      color: #ffffff;
    }

    .coi-table-wrapper {
      margin-top: 0.9rem;
      overflow-x: auto;
    }

    table.coi-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
      background: #ffffff;
      border-radius: 0.75rem;
      overflow: hidden;
    }

    .coi-table thead {
      background: #e5e7eb;
    }

    .coi-table th,
    .coi-table td {
      padding: 0.5rem 0.6rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
    }

    .coi-table th {
      font-weight: 600;
      color: #111827;
    }

    .coi-table tbody tr:last-child td {
      border-bottom: none;
    }

    .coi-status {
      font-weight: 600;
      font-size: 0.8rem;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      display: inline-block;
    }

    .coi-status-ok {
      background: #ecfdf3;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .coi-status-due {
      background: #fffbeb;
      color: #92400e;
      border: 1px solid #fed7aa;
    }

    .coi-status-expired {
      background: #fef2f2;
      color: #b91c1c;
      border: 1px solid #fecaca;
    }

    .coi-row-due {
      background: #fffbeb;
    }

    .coi-row-expired {
      background: #fef2f2;
    }

    .coi-empty {
      font-size: 0.85rem;
      color: #6b7280;
      padding: 0.4rem 0.1rem 0.2rem;
    }

    .coi-delete-btn {
      font-size: 0.78rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      border: 1px solid rgba(15, 23, 42, 0.18);
      background: #ffffff;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">
        <img src="logo.png" alt="Anchor Homes LLC logo" class="brand-logo" />
        <span class="brand-text">
          <span class="brand-name">Anchor Homes LLC</span>
          <span class="brand-tagline">Custom Homes &amp; Remodeling</span>
        </span>
      </a>

      <button class="nav-toggle" aria-label="Toggle navigation">
        <span></span><span></span><span></span>
      </button>

      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="projects.html">Projects</a>
        <a href="subcontractors.html">Subcontractors</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="anchor.html">Anchor</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="page-header">
      <div class="container">
        <h1>Anchor Owner Dashboard</h1>
        <p>
          Private area for managing subcontractor and project documents. This section
          is intended for the owner of Anchor Homes LLC.
        </p>
      </div>
    </section>

    <section class="section">
      <div class="container anchor-wrapper">
        <!-- Login card -->
        <div class="form-card anchor-login-card" id="anchor-login-card">
          <h1>Owner login</h1>
          <p style="font-size:0.9rem;margin-top:0;">
            Enter your password to view the Anchor dashboard.
          </p>

          <form id="anchor-login-form">
            <div class="anchor-login-row">
              <label class="form-label" for="anchor-password">Password</label>
              <input
                id="anchor-password"
                type="password"
                class="form-input"
                autocomplete="off"
                required
              />
            </div>

            <div style="margin-top:1rem;display:flex;align-items:center;">
              <button type="submit" class="btn primary">
                Log in
              </button>
              <span class="anchor-login-error" id="anchor-login-error">
                Incorrect password. Please try again.
              </span>
            </div>
          </form>
        </div>

        <!-- Dashboard (hidden until password is correct) -->
        <div class="form-card anchor-dashboard" id="anchor-dashboard" style="display:none;margin-top:1.5rem;">
          <h2>Documents</h2>
          <p style="font-size:0.9rem;margin-top:0;margin-bottom:1rem;">
            Use the embedded Box widget or the shortcut below to manage your
            subcontractor and project documents.
          </p>

          <!-- Box file manager card -->
          <div class="anchor-section-card">
            <h3>Anchor File Manager</h3>
            <p>
              The Box widget below lets you browse, preview, and manage files. Use
              it as your main “file explorer” for Anchor Homes.
            </p>

            <div class="anchor-links">
              <!-- Box main link (optional – opens Box in a full tab) -->
              <a
                href="https://app.box.com/folder/0"
                target="_blank"
                rel="noopener"
              >
                Open Box in a new tab
              </a>
            </div>

            <!-- Box embed widget -->
            <div class="anchor-iframe-wrapper">
              <iframe
                src="https://app.box.com/embed/s/duirh1egpllrudljdi66mrzsmv37uvsw?sortColumn=date"
                width="800"
                height="550"
                frameborder="0"
                allowfullscreen
                webkitallowfullscreen
                msallowfullscreen
              ></iframe>
            </div>

            <p class="anchor-note">
              You can upload files, create folders, and manage documents directly in
              this Box embed. For more advanced actions, use the “Open Box in a new
              tab” button above.
            </p>
          </div>

          <!-- Subcontractor COI Tracker -->
          <div class="anchor-section-card" id="coi-card">
            <h3>Subcontractor COI Tracker</h3>
            <p>
              Track Workers Compensation and General Liability renewal dates for each
              subcontractor. When a renewal date is within 30 days, it will appear in
              the COI alert bar so you know to request an updated certificate before
              paying them.
            </p>

            <!-- Add COI form -->
            <form id="coi-form">
              <div class="coi-form-grid">
                <div>
                  <label class="form-label" for="coi-name">Subcontractor name</label>
                  <input
                    id="coi-name"
                    name="coi_name"
                    class="form-input"
                    placeholder="e.g., Smith Electric LLC"
                    required
                  />
                </div>
                <div>
                  <label class="form-label" for="coi-wc-date">
                    Workers Comp renewal
                  </label>
                  <input
                    id="coi-wc-date"
                    name="coi_wc_date"
                    type="date"
                    class="form-input"
                  />
                </div>
                <div>
                  <label class="form-label" for="coi-gl-date">
                    General Liability renewal
                  </label>
                  <input
                    id="coi-gl-date"
                    name="coi_gl_date"
                    type="date"
                    class="form-input"
                  />
                </div>
                <div>
                  <button type="submit" class="btn primary" style="width:100%;min-width:120px;">
                    Add / Update
                  </button>
                </div>
              </div>
              <p style="font-size:0.8rem;color:#6b7280;margin-top:0.4rem;">
                Tip: You can leave one of the dates blank if a subcontractor only has
                Workers Comp or only General Liability at the moment.
              </p>
            </form>

            <!-- COI alert bar (shows only when there are renewals within 30 days) -->
            <div class="coi-alert-bar" id="coi-alert-bar">
              <div class="coi-alert-title">Renewals within 30 days</div>
              <div class="coi-alert-list" id="coi-alert-list"></div>
            </div>

            <!-- Quick filter bar -->
            <div class="coi-filter-bar">
              <span class="coi-filter-label">Show:</span>
              <button type="button" class="coi-filter-btn active" data-filter="all">
                All
              </button>
              <button type="button" class="coi-filter-btn" data-filter="due">
                Due soon (≤ 30 days)
              </button>
              <button type="button" class="coi-filter-btn" data-filter="expired">
                Expired
              </button>
              <button type="button" class="coi-filter-btn" data-filter="ok">
                Active / OK
              </button>
            </div>

            <!-- COI table -->
            <div class="coi-table-wrapper">
              <table class="coi-table" id="coi-table">
                <thead>
                  <tr>
                    <th>Subcontractor</th>
                    <th>WC renewal</th>
                    <th>WC days</th>
                    <th>WC status</th>
                    <th>GL renewal</th>
                    <th>GL days</th>
                    <th>GL status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="coi-table-body">
                  <!-- Filled by JS -->
                </tbody>
              </table>
              <div class="coi-empty" id="coi-empty-message">
                No subcontractors tracked yet. Add a name and at least one renewal
                date above.
              </div>
            </div>

            <p class="anchor-note">
              COI reminders are stored in Firebase so you can view this tracker on
              any device using this dashboard (subject to your Firestore security rules).
            </p>
          </div>

          <p class="anchor-note">
            This login is a simple page-level password for convenience. Real security
            for your files and COI documents is handled by Box and Firebase — use
            Firestore security rules to restrict who can read or write this data.
          </p>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container site-footer-inner">
      <span>&copy; <span id="year"></span> Anchor Homes LLC.</span>
      <span>Private owner area.</span>
    </div>
  </footer>

  <script src="scripts.js"></script>

  <!-- Non-module script: just year + login -->
  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    // Simple front-end password gate
    const OWNER_PASSWORD = "Breamteam#25";

    const loginForm = document.getElementById("anchor-login-form");
    const passwordInput = document.getElementById("anchor-password");
    const loginError = document.getElementById("anchor-login-error");
    const loginCard = document.getElementById("anchor-login-card");
    const dashboard = document.getElementById("anchor-dashboard");

    loginForm.addEventListener("submit", function (e) {
      e.preventDefault();
      const val = passwordInput.value || "";

      if (val === OWNER_PASSWORD) {
        loginError.style.display = "none";
        loginCard.style.display = "none";
        dashboard.style.display = "block";
        passwordInput.value = "";
        window.scrollTo({ top: 0, behavior: "smooth" });
      } else {
        loginError.style.display = "inline";
      }
    });
  </script>

  <!-- Firebase + COI tracker (module) -->
  <script type="module">
    // Import Firebase SDKs (v12.6.0)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      doc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDZmiuGCuqufL_yF2EHwLKWNlPCzIhr2TU",
      authDomain: "tracker-5d621.firebaseapp.com",
      projectId: "tracker-5d621",
      storageBucket: "tracker-5d621.firebasestorage.app",
      messagingSenderId: "950779208174",
      appId: "1:950779208174:web:ce37c7167ea0e125b0eeff",
      measurementId: "G-GX3M1SWVD2"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);
    const coiCollection = collection(db, "coiRecords");

    // --------- DOM references ----------
    const coiForm = document.getElementById("coi-form");
    const coiNameInput = document.getElementById("coi-name");
    const coiWcInput = document.getElementById("coi-wc-date");
    const coiGlInput = document.getElementById("coi-gl-date");
    const coiTableBody = document.getElementById("coi-table-body");
    const coiEmptyMessage = document.getElementById("coi-empty-message");
    const coiAlertBar = document.getElementById("coi-alert-bar");
    const coiAlertList = document.getElementById("coi-alert-list");

    const coiFilterButtons = document.querySelectorAll(".coi-filter-btn");
    let currentFilter = "all";

    // --------- Firestore helpers ----------
    async function loadCoiList() {
      try {
        const snapshot = await getDocs(coiCollection);
        const list = [];
        snapshot.forEach((docSnap) => {
          const data = docSnap.data();
          list.push({
            id: docSnap.id,
            name: data.name || "",
            wcDate: data.wcDate || "",
            glDate: data.glDate || ""
          });
        });
        return list;
      } catch (e) {
        console.error("Error loading COI data from Firebase:", e);
        alert("There was an error loading COI data from Firebase.");
        return [];
      }
    }

    async function saveCoiRecord(name, wcDate, glDate) {
      try {
        // Simple id based on subcontractor name
        const id = name.trim().toLowerCase().replace(/[^a-z0-9]+/g, "_");
        await setDoc(doc(db, "coiRecords", id), {
          name,
          wcDate: wcDate || "",
          glDate: glDate || ""
        });
      } catch (e) {
        console.error("Error saving COI record:", e);
        alert("There was an error saving this COI record to Firebase.");
      }
    }

    async function deleteCoiRecord(id) {
      try {
        await deleteDoc(doc(db, "coiRecords", id));
      } catch (e) {
        console.error("Error deleting COI record:", e);
        alert("There was an error deleting this COI record from Firebase.");
      }
    }

    // --------- Date + status helpers ----------
    function daysBetween(today, target) {
      const oneDay = 24 * 60 * 60 * 1000;
      const start = new Date(
        today.getFullYear(),
        today.getMonth(),
        today.getDate()
      ).getTime();
      const end = new Date(
        target.getFullYear(),
        target.getMonth(),
        target.getDate()
      ).getTime();
      return Math.round((end - start) / oneDay);
    }

    function formatDateDisplay(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr + "T00:00:00");
      if (isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString(undefined, {
        year: "numeric",
        month: "short",
        day: "numeric"
      });
    }

    function computeStatus(dateStr, today) {
      if (!dateStr) {
        return {
          diff: null,
          text: "Not set",
          statusClass: "coi-status-ok",
          rowFlag: null
        };
      }
      const dueDate = new Date(dateStr + "T00:00:00");
      if (isNaN(dueDate.getTime())) {
        return {
          diff: null,
          text: "Invalid date",
          statusClass: "coi-status-expired",
          rowFlag: "expired"
        };
      }
      const diff = daysBetween(today, dueDate);
      if (diff < 0) {
        return {
          diff,
          text: "Expired",
          statusClass: "coi-status-expired",
          rowFlag: "expired"
        };
      } else if (diff <= 30) {
        return {
          diff,
          text: diff === 0 ? "Due today" : `Due in ${diff} day${diff === 1 ? "" : "s"}`,
          statusClass: "coi-status-due",
          rowFlag: "due"
        };
      } else {
        return {
          diff,
          text: `OK (${diff} days)`,
          statusClass: "coi-status-ok",
          rowFlag: "ok"
        };
      }
    }

    // --------- Render + filter ----------
    async function renderCoiList() {
      const list = await loadCoiList();
      coiTableBody.innerHTML = "";
      coiAlertList.innerHTML = "";

      const today = new Date();
      let anyDueSoon = false;

      if (!list.length) {
        coiEmptyMessage.style.display = "block";
      } else {
        coiEmptyMessage.style.display = "none";
      }

      list
        .slice()
        .sort((a, b) => {
          const aDate = a.wcDate || a.glDate || "";
          const bDate = b.wcDate || b.glDate || "";
          return new Date(aDate) - new Date(bDate);
        })
        .forEach((item) => {
          const tr = document.createElement("tr");
          tr.dataset.id = item.id;

          const wcStatus = computeStatus(item.wcDate, today);
          const glStatus = computeStatus(item.glDate, today);

          let rowStatus = "ok";
          if (wcStatus.rowFlag === "expired" || glStatus.rowFlag === "expired") {
            tr.classList.add("coi-row-expired");
            rowStatus = "expired";
          } else if (wcStatus.rowFlag === "due" || glStatus.rowFlag === "due") {
            tr.classList.add("coi-row-due");
            rowStatus = "due";
          } else {
            rowStatus = "ok";
          }
          tr.dataset.status = rowStatus;

          const nameTd = document.createElement("td");
          nameTd.textContent = item.name;
          tr.appendChild(nameTd);

          const wcDateTd = document.createElement("td");
          wcDateTd.textContent = formatDateDisplay(item.wcDate);
          tr.appendChild(wcDateTd);

          const wcDaysTd = document.createElement("td");
          wcDaysTd.textContent =
            wcStatus.diff === null || isNaN(wcStatus.diff) ? "-" : wcStatus.diff;
          tr.appendChild(wcDaysTd);

          const wcStatusTd = document.createElement("td");
          const wcSpan = document.createElement("span");
          wcSpan.className = "coi-status " + wcStatus.statusClass;
          wcSpan.textContent = wcStatus.text;
          wcStatusTd.appendChild(wcSpan);
          tr.appendChild(wcStatusTd);

          const glDateTd = document.createElement("td");
          glDateTd.textContent = formatDateDisplay(item.glDate);
          tr.appendChild(glDateTd);

          const glDaysTd = document.createElement("td");
          glDaysTd.textContent =
            glStatus.diff === null || isNaN(glStatus.diff) ? "-" : glStatus.diff;
          tr.appendChild(glDaysTd);

          const glStatusTd = document.createElement("td");
          const glSpan = document.createElement("span");
          glSpan.className = "coi-status " + glStatus.statusClass;
          glSpan.textContent = glStatus.text;
          glStatusTd.appendChild(glSpan);
          tr.appendChild(glStatusTd);

          const actionsTd = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "coi-delete-btn";
          delBtn.textContent = "Remove";
          delBtn.addEventListener("click", async () => {
            const id = tr.dataset.id;
            await deleteCoiRecord(id);
            await renderCoiList();
          });
          actionsTd.appendChild(delBtn);
          tr.appendChild(actionsTd);

          coiTableBody.appendChild(tr);

          if (wcStatus.rowFlag === "due" && wcStatus.diff !== null && !isNaN(wcStatus.diff)) {
            anyDueSoon = true;
            const chip = document.createElement("div");
            chip.className = "coi-alert-chip";
            chip.textContent =
              item.name +
              " – WC " +
              (wcStatus.diff === 0
                ? "due today"
                : `due in ${wcStatus.diff} day${wcStatus.diff === 1 ? "" : "s"}`);
            coiAlertList.appendChild(chip);
          }

          if (glStatus.rowFlag === "due" && glStatus.diff !== null && !isNaN(glStatus.diff)) {
            anyDueSoon = true;
            const chip = document.createElement("div");
            chip.className = "coi-alert-chip";
            chip.textContent =
              item.name +
              " – GL " +
              (glStatus.diff === 0
                ? "due today"
                : `due in ${glStatus.diff} day${glStatus.diff === 1 ? "" : "s"}`);
            coiAlertList.appendChild(chip);
          }
        });

      coiAlertBar.style.display = anyDueSoon ? "block" : "none";
      applyCoiFilter(currentFilter);
    }

    function applyCoiFilter(mode) {
      currentFilter = mode;
      const rows = coiTableBody.querySelectorAll("tr");

      rows.forEach((row) => {
        const status = row.dataset.status || "ok";

        if (mode === "all") {
          row.style.display = "";
        } else if (mode === "due") {
          row.style.display = status === "due" ? "" : "none";
        } else if (mode === "expired") {
          row.style.display = status === "expired" ? "" : "none";
        } else if (mode === "ok") {
          row.style.display = status === "ok" ? "" : "none";
        }
      });

      coiFilterButtons.forEach((btn) => {
        if (btn.dataset.filter === mode) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      });
    }

    coiFilterButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const mode = btn.dataset.filter || "all";
        applyCoiFilter(mode);
      });
    });

    coiForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const name = coiNameInput.value.trim();
      const wcDate = coiWcInput.value;
      const glDate = coiGlInput.value;

      if (!name) return;

      if (!wcDate && !glDate) {
        alert("Please enter at least one renewal date (Workers Comp or General Liability).");
        return;
      }

      await saveCoiRecord(name, wcDate, glDate);
      await renderCoiList();

      coiNameInput.value = "";
      coiWcInput.value = "";
      coiGlInput.value = "";
    });

    document.addEventListener("DOMContentLoaded", () => {
      renderCoiList();
    });
  </script>
</body>
</html>
