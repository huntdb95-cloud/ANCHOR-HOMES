<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>W-9 Form | Anchor Homes LLC</title>
  <link rel="stylesheet" href="styles.css" />

  <!-- W-9 capture layout (hidden, prints like an actual form) -->
  <style>
    /* Hidden wrapper so user doesn't see the W-9 capture, but html2canvas can */
    #w9-capture-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      opacity: 0;           /* invisible but still fully rendered */
      pointer-events: none;
    }

    .w9-capture-page {
      width: 8.5in;
      height: 11in;
      position: relative;
      background: #ffffff;
      overflow: hidden;
      box-sizing: border-box;
      padding: 0;
    }

    .w9-image {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .w9-text-line {
      position: absolute;
      font-family: "Times New Roman", "Georgia", serif;
      font-size: 10pt;
      color: #111827;
      white-space: nowrap;
      max-width: 60%;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Approximate positions for a standard IRS W-9 layout. */

    /* Line 1 – Name */
    #w9-name-text {
      top: 15%;
      left: 12%;
      max-width: 65%;
    }

    /* Line 2 – Business name */
    #w9-business-text {
      top: 18.2%;
      left: 12%;
      max-width: 65%;
    }

    /* Tax classification text */
    #w9-tax-class-text {
      top: 28.75%;
      left: 26.5%;
      max-width: 75%;
      font-size: 9pt;
    }

    /* Address line */
    #w9-address-text {
      top: 36.5%;
      left: 12%;
      max-width: 65%;
    }

    /* City/state/ZIP */
    #w9-city-text {
      top: 39.5%;
      left: 12%;
      max-width: 65%;
    }

    /* SSN field */
    #w9-ssn-text {
      top: 48.75%;
      left: 56%;
      max-width: 25%;
      letter-spacing: 0.1em;
    }

    /* EIN field */
    #w9-ein-text {
      top: 54%;
      left: 69%;
      max-width: 16%;
      letter-spacing: 0.1em;
    }

    /* Signature image on signature line */
    #w9-signature-image {
      position: absolute;
      bottom: 22.5%;
      left: 11%;
      width: 35%;
      height: 10%;
      object-fit: contain;
    }

    /* Date text */
    #w9-date-text {
      position: absolute;
      bottom: 25%;
      right: 31%;
      max-width: 15%;
      color: #000000;
    }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <a href="index.html" class="brand">
        <img src="logo.png" alt="Anchor Homes LLC logo" class="brand-logo" />
        <span class="brand-text">
          <span class="brand-name">Anchor Homes LLC</span>
          <span class="brand-tagline">Custom Homes &amp; Remodeling</span>
        </span>
      </a>

      <button class="nav-toggle" aria-label="Toggle navigation">
        <span></span><span></span><span></span>
      </button>

      <nav class="main-nav">
        <a href="index.html">Home</a>
        <a href="projects.html">Projects</a>
        <a href="subcontractors.html">Subcontractors</a>
        <a href="about.html">About</a>
        <a href="contact.html">Contact</a>
        <a href="anchor.html">Anchor</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="page-header">
      <div class="container">
        <h1>W-9 – Taxpayer Identification</h1>
        <p>
          Please complete this W-9 information. We’ll place your details and
          signature onto the official W-9 form image and send a full 8.5&quot; x
          11&quot; copy to Anchor Homes LLC via Formspree.
        </p>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <form
          id="w9-form"
          action="https://formspree.io/f/xdkqdpgd"
          method="POST"
          enctype="multipart/form-data"
        >
          <!-- Basic contact info -->
          <div class="form-card">
            <h2 style="margin-top:0;margin-bottom:0.75rem;">Contact information</h2>
            <div class="form-grid">
              <div>
                <label class="form-label" for="contact-name">Your Name</label>
                <input
                  id="contact-name"
                  name="contact_name"
                  class="form-input"
                  required
                />
              </div>
              <div>
                <label class="form-label" for="contact-email">Email</label>
                <input
                  id="contact-email"
                  name="contact_email"
                  type="email"
                  class="form-input"
                  required
                />
              </div>
              <div>
                <label class="form-label" for="contact-phone">Phone</label>
                <input
                  id="contact-phone"
                  name="contact_phone"
                  type="tel"
                  class="form-input"
                />
              </div>
              <div class="form-row-full">
                <label class="form-label" for="contact-notes">
                  Notes (optional)
                </label>
                <textarea
                  id="contact-notes"
                  name="contact_notes"
                  class="form-textarea"
                  placeholder="Anything else we should know."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- W-9 data entry (simple form) -->
          <div class="form-card" style="margin-top:1.75rem;">
            <h2 style="margin-top:0;margin-bottom:0.75rem;">W-9 details</h2>
            <p style="font-size:0.85rem;margin-top:0;">
              Enter your information below as it should appear on your W-9.
              We’ll overlay this onto the official form when we submit it.
            </p>

            <div class="form-grid">
              <div class="form-row-full">
                <label class="form-label" for="w9-name">
                  Name (as shown on your tax return)
                </label>
                <input
                  id="w9-name"
                  name="w9_name"
                  class="form-input"
                  required
                />
              </div>

              <div class="form-row-full">
                <label class="form-label" for="w9-business">
                  Business name / disregarded entity name (if different)
                </label>
                <input
                  id="w9-business"
                  name="w9_business"
                  class="form-input"
                />
              </div>

              <div class="form-row-full">
                <label class="form-label" for="w9-tax-class">
                  Federal tax classification (entity type)
                </label>
                <select
                  id="w9-tax-class"
                  name="w9_tax_class"
                  class="form-input"
                  required
                >
                  <option value="" disabled selected>-- Select entity type --</option>
                  <option value="Individual/sole proprietor or single-member LLC">
                    Individual / sole proprietor or single-member LLC
                  </option>
                  <option value="C Corporation">C Corporation</option>
                  <option value="S Corporation">S Corporation</option>
                  <option value="Partnership">Partnership</option>
                  <option value="Trust/estate">Trust / estate</option>
                  <option value="Limited liability company">
                    LLC (Limited liability company)
                  </option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="form-row-full">
                <label class="form-label" for="w9-address">
                  Address (number, street, and apt. or suite no.)
                </label>
                <input
                  id="w9-address"
                  name="w9_address"
                  class="form-input"
                  required
                />
              </div>

              <div class="form-row-full">
                <label class="form-label" for="w9-city">
                  City, state, and ZIP code
                </label>
                <input
                  id="w9-city"
                  name="w9_city"
                  class="form-input"
                  required
                />
              </div>

              <div class="form-row-full">
                <label class="form-label">
                  Taxpayer Identification Number (choose one)
                </label>
                <div class="form-grid">
                  <div>
                    <label class="form-label" for="w9-ssn">
                      SSN (###-##-####)
                    </label>
                    <input
                      id="w9-ssn"
                      name="w9_ssn"
                      class="form-input"
                      placeholder="123-45-6789"
                    />
                  </div>
                  <div>
                    <label class="form-label" for="w9-ein">
                      EIN (##-#######)
                    </label>
                    <input
                      id="w9-ein"
                      name="w9_ein"
                      class="form-input"
                      placeholder="12-3456789"
                    />
                  </div>
                </div>
                <p style="font-size:0.78rem;color:var(--color-text-muted);margin-top:0.35rem;">
                  Please provide either SSN or EIN (one is required).
                </p>
              </div>

              <div class="form-row-full">
                <label class="form-label">
                  Signature (sign in the box below)
                </label>
                <div class="signature-pad-wrapper">
                  <canvas id="w9-signature-pad" class="signature-pad"></canvas>
                </div>
              </div>

              <div>
                <label class="form-label" for="w9-date">
                  Date
                </label>
                <input
                  id="w9-date"
                  name="w9_date"
                  class="form-input"
                  placeholder="MM/DD/YYYY"
                  required
                />
              </div>
            </div>

            <div style="margin-top:0.75rem;text-align:right;">
              <button
                type="button"
                class="btn secondary"
                id="btn-clear-w9-signature"
              >
                Clear signature
              </button>
            </div>
          </div>

          <div style="margin-top:1.25rem;display:flex;flex-direction:column;gap:0.4rem;">
            <button type="submit" class="btn primary">
              Submit W-9 to Anchor Homes
            </button>
            <div id="w9-status" style="font-size:0.84rem;"></div>
          </div>
        </form>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container site-footer-inner">
      <span>&copy; <span id="year"></span> Anchor Homes LLC.</span>
      <span>Thank you for partnering with us.</span>
    </div>
  </footer>

  <script src="scripts.js"></script>
  <!-- Signature pad + html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Hidden W-9 capture (official image + overlay text) -->
  <div id="w9-capture-wrapper">
    <div id="w9-capture" class="w9-capture-page">
      <!-- Make sure this path & file name matches your actual image -->
      <img
        src="w9.png"
        alt="IRS Form W-9"
        class="w9-image"
      />

      <!-- Overlay text fields -->
      <div id="w9-name-text" class="w9-text-line"></div>
      <div id="w9-business-text" class="w9-text-line"></div>
      <div id="w9-tax-class-text" class="w9-text-line"></div>
      <div id="w9-address-text" class="w9-text-line"></div>
      <div id="w9-city-text" class="w9-text-line"></div>
      <div id="w9-ssn-text" class="w9-text-line"></div>
      <div id="w9-ein-text" class="w9-text-line"></div>

      <!-- Signature + date overlay -->
      <img id="w9-signature-image" alt="Signature on W-9" />
      <div id="w9-date-text"></div>
    </div>
  </div>

  <script>
    document.getElementById("year").textContent = new Date().getFullYear();

    const W9_KEY = "sub_w9_completed";

    const form = document.getElementById("w9-form");
    const statusEl = document.getElementById("w9-status");

    const sigCanvas = document.getElementById("w9-signature-pad");

    function initSignatureCanvas(canvas) {
      if (!canvas) return;
      const parent = canvas.parentElement;
      const width = parent.clientWidth || 300;
      const height = parent.clientHeight || 100;
      canvas.width = width;
      canvas.height = height;
    }

    initSignatureCanvas(sigCanvas);

    const w9Pad = new SignaturePad(sigCanvas, {
      penColor: "#000000",
      backgroundColor: "rgba(0,0,0,0)"
    });

    document
      .getElementById("btn-clear-w9-signature")
      .addEventListener("click", () => w9Pad.clear());

    function getSelectedTaxClass() {
      const select = document.getElementById("w9-tax-class");
      return select ? select.value : "";
    }

    // Wait for the W-9 background image to load so html2canvas can see it
    function waitForW9Image() {
      const img = document.querySelector("#w9-capture .w9-image");
      if (!img) {
        console.warn("W-9 image element not found in DOM.");
        return Promise.resolve();
      }

      if (img.complete && img.naturalWidth !== 0) {
        return Promise.resolve();
      }

      return new Promise((resolve) => {
        img.addEventListener(
          "load",
          () => {
            console.log("W-9 background image loaded.");
            resolve();
          },
          { once: true }
        );
        img.addEventListener(
          "error",
          () => {
            console.error(
              "Failed to load W-9 background image. Check the src path for w9.png."
            );
            resolve(); // still resolve so the form can submit with just overlay if needed
          },
          { once: true }
        );
      });
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusEl.className = "";
      statusEl.textContent = "Preparing W-9… please wait.";

      const nameVal = document.getElementById("w9-name").value.trim();
      const ssnVal = document.getElementById("w9-ssn").value.trim();
      const einVal = document.getElementById("w9-ein").value.trim();
      const taxClassVal = getSelectedTaxClass();

      if (!nameVal) {
        statusEl.className = "error";
        statusEl.textContent = "Please enter your name (line 1).";
        return;
      }

      if (!taxClassVal) {
        statusEl.className = "error";
        statusEl.textContent = "Please select your Federal tax classification.";
        return;
      }

      if (!ssnVal && !einVal) {
        statusEl.className = "error";
        statusEl.textContent = "Please provide either SSN or EIN.";
        return;
      }

      if (w9Pad.isEmpty()) {
        statusEl.className = "error";
        statusEl.textContent = "Please sign the W-9 before submitting.";
        return;
      }

      const capturePage = document.getElementById("w9-capture");

      try {
        // Ensure the W-9 background has loaded
        await waitForW9Image();

        // Fill overlay text from form fields
        document.getElementById("w9-name-text").textContent =
          document.getElementById("w9-name").value;
        document.getElementById("w9-business-text").textContent =
          document.getElementById("w9-business").value;
        document.getElementById("w9-tax-class-text").textContent =
          "Tax classification: " + taxClassVal;
        document.getElementById("w9-address-text").textContent =
          document.getElementById("w9-address").value;
        document.getElementById("w9-city-text").textContent =
          document.getElementById("w9-city").value;
        document.getElementById("w9-ssn-text").textContent = ssnVal;
        document.getElementById("w9-ein-text").textContent = einVal;
        document.getElementById("w9-date-text").textContent =
          document.getElementById("w9-date").value;

        // Put signature image into the overlay
        const sigDataUrl = sigCanvas.toDataURL("image/png");
        const sigImg = document.getElementById("w9-signature-image");
        sigImg.src = sigDataUrl;

        // Capture full W-9 page as a large PNG
        const w9Canvas = await html2canvas(capturePage, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff",
          logging: false
        });

        const w9Blob = await new Promise((resolve) =>
          w9Canvas.toBlob(resolve, "image/png")
        );

        const formData = new FormData(form);
        if (w9Blob) {
          formData.append("w9_file", w9Blob, "w9-completed.png");
        } else {
          console.error("html2canvas returned a null blob – background may be cross-origin.");
        }

        const response = await fetch(form.action, {
          method: "POST",
          body: formData,
          headers: { Accept: "application/json" }
        });

        if (response.ok) {
          localStorage.setItem(W9_KEY, "true");
          window.location.href = "subcontractors.html?w9=done";
        } else {
          statusEl.className = "error";
          statusEl.textContent =
            "There was a problem submitting your W-9. Please try again.";
        }
      } catch (err) {
        console.error(err);
        statusEl.className = "error";
        statusEl.textContent =
          "Unexpected error preparing the W-9. Please refresh and try again.";
      }
    });
  </script>
</body>
</html>
